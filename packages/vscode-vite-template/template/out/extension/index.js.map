{"version":3,"file":"index.js","sources":["../../src/extension/pageview.ts","../../src/extension/config.ts","../../src/extension/commands.ts","../../src/common.ts","../../src/extension/index.ts"],"sourcesContent":["import { CancellationToken, ExtensionContext, Position, TextDocument, Uri, WebviewView, WebviewViewProvider, WebviewViewResolveContext, window, Range } from \"vscode\";\r\n\r\n// 消息类型\r\nexport type MsgType = 'update' | 'update-from-page' | 'show-text' | 'hidden-text';\r\n\r\nexport interface Msg {\r\n  type: MsgType;\r\n  value?: any;\r\n}\r\n\r\nexport class PageView implements WebviewViewProvider {\r\n\r\n  private extensionUri: Uri;\r\n\r\n  private view: WebviewView | undefined;\r\n\r\n  constructor(context: ExtensionContext) {\r\n    // 设置 Uri\r\n    this.extensionUri = context.extensionUri;\r\n  }\r\n\r\n  /**\r\n   * 解析 Webview 视图。\r\n   * @param webviewView Webview 视图实例。\r\n   * @param context Webview 视图解析上下文。\r\n   * @param token 取消令牌。\r\n   */\r\n  resolveWebviewView (webviewView: WebviewView, context: WebviewViewResolveContext<unknown>, token: CancellationToken): void | Thenable<void> {\r\n    this.view = webviewView;\r\n\r\n    this.view.webview.options = {\r\n      enableScripts: true, // 允许使用 scripts，要给页面加入脚本\r\n      localResourceRoots: [\r\n        this.extensionUri, // 设置路径\r\n      ],\r\n    };\r\n\r\n    this.render(); // 渲染\r\n    this.view.webview.onDidReceiveMessage((str: string) => { // 监听 message\r\n      const message = JSON.parse(str) as Msg;\r\n      switch (message.type) {\r\n        // 获取到页面返回的内容\r\n        case 'update-from-page':\r\n          if (window.activeTextEditor) {\r\n            const document = window.activeTextEditor.document;\r\n            window.activeTextEditor.edit(editBuilder => {\r\n              // 获取文档内容范围\r\n              const start = new Position(0, 0);\r\n              const end = document.lineAt(document.lineCount - 1).range.end;\r\n              const wholeRange = new Range(start, end);\r\n              // 更新文档内容\r\n              editBuilder.replace(wholeRange, message.value);\r\n            });\r\n          }\r\n          break;\r\n      }\r\n    });\r\n    this.build();\r\n  }\r\n\r\n  /**\r\n   * 渲染 Webview 视图。\r\n   */\r\n  // 修改 render 方法\r\n  render () {\r\n    if (!this.view) {\r\n      return;\r\n    }\r\n    this.view.webview.html = `<!DOCTYPE html>\r\n    <html lang=\"en\">\r\n      <head>\r\n        <meta charset=\"UTF-8\" />\r\n        <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\" />\r\n        <title>Page</title>\r\n        <link href=\"${this.getAssetUri('out/webview/index.css')}\" rel=\"stylesheet\" />\r\n      </head>\r\n      <body>\r\n        <div id=\"app\"></div>\r\n        <script type=\"module\" src=\"${this.getAssetUri('out/webview/index.js')}\"></script>\r\n      </body>\r\n    </html>`;\r\n  }\r\n\r\n  /**\r\n   * 构建 Webview 视图。\r\n   */\r\n  build () {\r\n    this.update(window.activeTextEditor?.document || window.visibleTextEditors[0].document);\r\n  }\r\n\r\n  /**\r\n   * 使用给定的文本文档更新 Webview 视图。\r\n   * @param textDocument 要更新 Webview 的文本文档。\r\n   */\r\n  update (textDocument: TextDocument) {\r\n    this.postMessage({\r\n      type: 'update',\r\n      value: textDocument.getText(),\r\n    });\r\n  }\r\n\r\n  /**\r\n   * 获取给定路径的资源 URI。\r\n   * @param path 资源路径。\r\n   * @returns 资源 URI。\r\n   */\r\n  getAssetUri (path: string) {\r\n    return this.view?.webview.asWebviewUri(Uri.joinPath(this.extensionUri, ...path.split('/')));\r\n  };\r\n\r\n  /**\r\n   * 向 Webview 视图发送消息。\r\n   * @param message 要发送的消息。\r\n   */\r\n  postMessage (message: Msg) {\r\n    this.view?.webview.postMessage(message);\r\n  }\r\n}","export const VIEW_NAME = \"test-page\"","import { commands } from \"vscode\"\r\nimport { PageView } from \"./pageview\";\r\nimport * as vscode from 'vscode';\r\nimport { VIEW_NAME } from \"./config\";\r\n\r\nexport enum ShowStatus {\r\n  hidden,\r\n  show,\r\n}\r\n\r\nexport interface Command {\r\n  name: string;\r\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n  fn: (...args: any[]) => any;\r\n}\r\n\r\nexport const setExpandStatus = (status: ShowStatus) => {\r\n  commands.executeCommand('setContext', `${VIEW_NAME}.show`, status);\r\n}\r\n\r\nexport const getDisposableList = (codeView: PageView): Command[] => {\r\n\r\n  const commandList: Command[] = []\r\n\r\n  commands.executeCommand('setContext', `${VIEW_NAME}.show`, ShowStatus.show);\r\n\r\n  // 默认的命令\r\n  commandList.push({\r\n    name: `${VIEW_NAME}.helloWorld`,\r\n    fn: () => {\r\n      vscode.window.showInformationMessage('Hello World from test-page!');\r\n    }\r\n  });\r\n\r\n  commandList.push({\r\n    name: `${VIEW_NAME}.showText`,\r\n    fn: () => {\r\n      codeView.postMessage({\r\n        type: 'show-text',\r\n        value: true,\r\n      });\r\n      setExpandStatus(ShowStatus.show)\r\n    }\r\n  });\r\n\r\n  commandList.push({\r\n    name: `${VIEW_NAME}.hiddenText`,\r\n    fn: () => {\r\n      codeView.postMessage({\r\n        type: 'hidden-text',\r\n        value: false,\r\n      });\r\n      setExpandStatus(ShowStatus.hidden)\r\n    }\r\n  });\r\n\r\n  return commandList\r\n}","export const debounce = (func: Function, delay: number) => {\r\n  let timer: any = null;\r\n\r\n  return function (this: any, ...args: any[]) {\r\n    if (timer) {\r\n      clearTimeout(timer);\r\n    }\r\n    timer = setTimeout(() => {\r\n      func.apply(this, args);\r\n    }, delay);\r\n  };\r\n}","import * as vscode from 'vscode';\nimport { PageView } from './pageview';\nimport { TextDocumentChangeEvent, window, workspace, commands } from 'vscode';\nimport { getDisposableList } from './commands';\nimport { debounce } from '../common';\nimport { VIEW_NAME } from './config';\n\nexport function activate (context: vscode.ExtensionContext) {\n\n\n  // webview, 实现 WebviewViewProvider\n  const page = new PageView(context);\n\n  // 监听文件变化\n  window.onDidChangeActiveTextEditor(event => {\n    const document = event?.document || window.activeTextEditor?.document;\n    if (document) { page.update(document); }\n  });\n\n  // 监听文件内容变化\n  workspace.onDidChangeTextDocument(debounce((event: TextDocumentChangeEvent) => {\n    const document = event.document;\n    page.update(document);\n  }, 300));\n\n\n  // 设置页面，注意这里的 'test-page'，是 page 的 id，会在后面的 package.json 配置\n  context.subscriptions.push(\n    window.registerWebviewViewProvider(`${VIEW_NAME}`, page),\n    ...getDisposableList(page).map(command => commands.registerCommand(command.name, command.fn.bind(null))));\n}\n\n// This method is called when your extension is deactivated\nexport function deactivate () { }"],"names":["window","Position","Range","Uri","commands","vscode","workspace"],"mappings":"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"}